// wait for document's ready state
$(document).ready(function () {

   $(window).on("resize", function () {
      updateSize();
   });

   setTimeout(function () {
      init();
   }, 1000);
});

function init() {

   /// init() start ///


   // buttons //        

   $('.prefocus').on("click", function (e) {
      e.preventDefault();
   });

   $('.btn-prev').on("click", function () {
      prevSlide();
   });
   $('.btn-next').on("click", function () {
      nextSlide();
   });
   $('.btn-restart').on("click", function () {
      changeSlide(1, 1);
   });
   $('.btn-menu').on("click", function () {
      toggleMenu();
   });
   $('.btn-start').on("click", function () {
      currentSlide++;
   });

   $('.menu .menu-item').on("click", function (e) {
      e.preventDefault();
      var sectionNum = parseInt($(this).attr('data-num'));
      if (!$(this).hasClass('disabled')) {
         changeSlide(sectionNum, 1);
      }
   });

   $('.btn-start').on("click", function () {
      $('.content-div').fadeOut(500);
   });

   // functions //

   var menuOpen;

   function toggleMenu() {
      if (menuOpen) {
         closeMenu();
      } else {
         openMenu();
      }
   }

   function openMenu() {
      $('.menu').fadeIn(500);
      menuOpen = true;
   }

   function closeMenu() {
      $('.btn-menu').show();
      $('.menu').fadeOut(500);
      menuOpen = false;
   }

   function prevSlide() {
      var num = currentSlideGlobal - 1;
      navigateToSlide(num, "backwards");
   }

   function nextSlide() {
      var num = currentSlideGlobal + 1;
      navigateToSlide(num, "forward");
   }

   function navigateToSlide(num, dir) {

      var obj = $('.slideGlobal' + num);
      var sectionNum = parseInt(obj.parent().attr('data-section'), 10);
      var slideNum = parseInt(obj.attr('data-slide'), 10);
      var targetSlide = $('.section' + sectionNum + ' .slide' + slideNum);

      if (targetSlide.hasClass('subSlide')) {
         if (dir === 'forward') {
            num++;
            navigateToSlide(num, dir);
         } else {
            num--;
            navigateToSlide(num);
         }
      } else {
         changeSlide(sectionNum, slideNum);
      }
   }

   function goToSlideName(slide) {

      var obj = $(slide);
      var sectionNum = parseInt(obj.parent().attr('data-section'), 10);
      var slideNum = parseInt(obj.attr('data-slide'), 10);

      changeSlide(sectionNum, slideNum);

   }

   function changeSlide(section, num) {

      var oldSlide = '.section' + currentSection + ' .slide' + currentSlide;

      clearTimeouts();

      if (num === 0) {
         section--;
         num = 1;
      }

      currentSection = section;

      currentSlide = num;

      if (currentSlide === 1) {
         //mark previous section as done
         sectionsDone[currentSection - 1] = true;
      }

      var newSlide = '.section' + currentSection + ' .slide' + currentSlide;

      currentSlideGlobal = parseInt($(newSlide).attr('data-slide-global'));

      $(newSlide).html(slidesStorage[currentSlideGlobal]);

      $('.slides').fadeOut(500);

      $(newSlide).fadeIn(500);

      timeouts.push(setTimeout(function () {
         if (newSlide !== oldSlide) {
            $(oldSlide).empty();
         }
         $('.prefocus').focus();
      }, 500));

      updateNav();

      startAnimations();

      startInteractions();

      checkBtnNext();

      closeMenu();

   }

   function checkBtnNext() {

      var slide = $('.section' + currentSection + ' .slide' + currentSlide);

      if ((!slidesDone[currentSlideGlobal] || slide.hasClass('disableNext')) && lockedNavigation) {
         $('.btn-next').attr("disabled", true);
      }

      var duration = slide.attr('data-duration');

      if (duration !== void(0)) {
         timeouts.push(setTimeout(function () {
            slidesDone[currentSlideGlobal] = true;
            updateNav();
         }, duration));
      }
   }

   function startAnimations() {

      $('.section' + currentSection + ' .slide' + currentSlide + ' .animate').each(function () {

         var element = $(this);
         var delay = element.attr('data-delay');
         var duration = element.attr('data-duration');
         var direction = element.attr('data-direction');
         var distance = element.attr('data-distance');
         var transX = 0;
         var transY = 0;

         if (distance === void(0)) {
            distance = 0;
         }

         if (direction === 'right') {
            transX = '-' + distance;
         } else if (direction === 'left') {
            transX = distance;
         } else if (direction === 'up') {
            transY = distance;
         } else if (direction === 'down') {
            transY = '-' + distance;
         }

         var initialPos = {
            'transform': 'translate(' + transX + 'px,' + transY + 'px)',
            'opacity': 0,
            'transition': 'all 1s ease-out'
         };
         element.css(initialPos);
         element.hide();

         timeouts.push(setTimeout(function () {
            element.show();
         }, delay - 500));

         timeouts.push(setTimeout(function () {
            element.css({
               'transform': 'translate(0,0)',
               'opacity': 1
            });

            if (duration !== void(0)) {
               timeouts.push(setTimeout(function () {
                  element.fadeOut(500);
               }, duration));
            }

         }, delay));


      });

   }

   function startInteractions() {

      $('.section' + currentSection + ' .slide' + currentSlide + ' .action').click(function (e) {
         e.preventDefault();
         var element = $(this);
         var gotoSlide = element.attr('data-goto');

         goToSlideName(gotoSlide);

      });

   }

   function updateNav() {
      if (currentSlideGlobal <= 1) {
         currentSlideGlobal = 1;
         $('.btn-prev').attr("disabled", true);
      } else {
         $('.btn-prev').attr("disabled", false);
      }
      if (currentSlideGlobal >= totalSlides) {
         currentSlideGlobal = totalSlides;
         $('.btn-next').attr("disabled", true);
      } else {
         $('.btn-next').attr("disabled", false);
      }
      $('.menu .menu-item').each(function () {
         var btn = $(this);
         var n = btn.attr('data-num');
         // if (sectionsDone[n - 1] || !lockedNavigation) {
         //  btn.attr("disabled", false);
         //  btn.removeClass("disabled");
         // } else {
         //  btn.attr("disabled", true);
         //  btn.addClass("disabled");
         // }
      });
   }


   //// execute ////

   // MANAGE SECTIONS AND SLIDES

   var n = 1;
   var sectionN = 1;
   var slidesStorage = {};

   // for each section:
   $('.sections').each(function () {

      var thisSection = $(this);

      // set section number and class
      thisSection.attr('data-section', sectionN);
      thisSection.addClass('section' + sectionN);

      //for every slide within this Section:
      var p = 1;
      thisSection.find('.slides').each(function () {

         var thisSlide = $(this);

         //set slides' numbers and classes
         thisSlide.attr('data-section', sectionN);
         thisSlide.attr('data-slide', p);
         thisSlide.attr('data-slide-global', n);
         thisSlide.addClass('slide' + p);
         thisSlide.addClass('slideGlobal' + n);

         //Store slides' contents and remove them from the page
         slidesStorage[n] = thisSlide.contents();
         thisSlide.empty();

         totalSlides = n;

         //next positions
         n++;
         p++;

      });

      sectionN++;

   });


   // START CONTENT

   setTimeout(function () {

      //fade in main content
      $('#app').fadeIn(1000);

      //update elements sizes
      updateSize();

      //changeSlide(currentSection, currentSlide);
      updateNav();
      checkBtnNext();

      //open main menu
      openMenu();

      //force go to
      //navigateToSlide(21);

   }, 1);



   //

   /// init() end ///

}

function updateSize() {

   var proportion = 808 / 600;

   var W = $('.main-container').width();

   var H = W / proportion;

   $('.main-container').css({
      'min-height': H
   });

}

// "goto" function
(function ($) {
   $.fn.goTo = function () {
      $('html, body').animate({
         scrollTop: $(this).offset().top + 'px'
      });
      return this; // for chaining...
   };
})(jQuery);

// clear all timeouts
function clearTimeouts() {
   var total = timeouts.length;
   for (i = 0; i < total; i++) {
      clearTimeout(timeouts[i]);
   }
   timeouts = [];
}

// get size / length of js object
Object.size = function (obj) {
   var size = 0,
      key;
   for (key in obj) {
      if (obj.hasOwnProperty(key))
         size++;
   }
   return size;
};